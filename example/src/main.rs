use std::{
    fs::File,
    io::{Cursor, Read, Write},
};

use byteorder::{BigEndian, ReadBytesExt};
use rflv::{
    error::FlvError,
    file::FlvFile,
    ll::{
        audio::{AacAudioData, AudioData, FlvAudioTag},
        header::{FlvHeader, HeaderFlags, FLV_DATA_OFFSET, FLV_HEADER_SIGNATURE, FLV_HEADER_VERSION},
        tag::{calc_previous_tag_size, FlvTag, FlvTagData, FlvTagType},
        video::{AvcPacketType, AvcVideoPacket, CodecId, FlvVideoData, FrameType, VideoData},
    },
};

fn main() {
    let mut file = File::create("test.flv").unwrap();
    let sequence_header = FlvTagData::Video(FlvVideoData { frame_type: FrameType::KEYFRAME, codec: CodecId::AVC, video_data: VideoData::Avc(AvcVideoPacket {
        packet_type: AvcPacketType::SEQUENCE_HEADER,
        composition_time: 0,
        data: SEQUENCE_HEADER.to_vec()
    }) });
    let sequence_header_size = sequence_header.size() as u32;
    
    let frame = FlvTagData::Video(FlvVideoData { frame_type: FrameType::KEYFRAME, codec: CodecId::AVC, video_data: VideoData::Avc(AvcVideoPacket {
        packet_type: AvcPacketType::NALU,
        composition_time: 0,
        data: FRAME.to_vec()
    }) });
    let frame_size = frame.size() as u32;

    let flv = FlvFile {
        header: FlvHeader {
            signature: FLV_HEADER_SIGNATURE,
            version: FLV_HEADER_VERSION,
            flags: HeaderFlags::VIDEO,
            data_offset: FLV_DATA_OFFSET,
        },
        tags: vec![
            FlvTag {
                tag_type: FlvTagType::VIDEO,
                data_size: sequence_header_size,
                timestamp: 0,
                stream_id: 0,
                data: sequence_header,
                previous_tag_size: calc_previous_tag_size(sequence_header_size),
            },
            FlvTag {
                tag_type: FlvTagType::VIDEO,
                data_size: frame_size,
                timestamp: 0,
                stream_id: 0,
                data: frame,
                previous_tag_size: calc_previous_tag_size(frame_size),
            }
        ],
    };

    flv.encode(&mut file).unwrap();
}

const SEQUENCE_HEADER: &[u8] = &[
    0, 0, 0, 1, 103, 244, 0, 31, 145, 155, 40, 10, 0, 183, 77, 192, 128, 128, 16, 0, 0, 3, 0, 16,
    0, 0, 3, 3, 192, 241, 131, 25, 96, 0, 0, 0, 1, 104, 235, 227, 203, 34, 192,
];

const FRAME: &[u8] = &[
    0, 0, 0, 1, 103, 244, 0, 31, 145, 155, 40, 10, 0, 183, 77, 192, 128, 128, 16, 0, 0, 3, 0, 16, 0, 0, 3, 3, 192, 241, 131, 25, 96, 0, 0, 0, 1, 104, 235, 227, 203, 34, 192, 0, 0, 1, 6, 5, 255, 255, 156, 220, 69, 233, 189, 230, 217, 72, 183, 150, 44, 216, 32, 217, 35, 238, 239, 120, 50, 54, 52, 32, 45, 32, 99, 111, 114, 101, 32, 49, 54, 52, 32, 45, 32, 72, 46, 50, 54, 52, 47, 77, 80, 69, 71, 45, 52, 32, 65, 86, 67, 32, 99, 111, 100, 101, 99, 32, 45,
32, 67, 111, 112, 121, 108, 101, 102, 116, 32, 50, 48, 48, 51, 45, 50, 48, 50, 51, 32, 45, 32, 104, 116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 118, 105, 100, 101, 111, 108, 97, 110, 46, 111, 114, 103, 47, 120, 50, 54, 52, 46, 104, 116, 109, 108, 32, 45, 32, 111, 112, 116, 105, 111, 110, 115, 58, 32, 99, 97, 98, 97, 99, 61, 49, 32, 114, 101, 102, 61, 51, 32, 100, 101, 98, 108,
111, 99, 107, 61, 49, 58, 48, 58, 48, 32, 97, 110, 97, 108, 121, 115, 101, 61, 48, 120, 51, 58, 48, 120, 49, 49, 51, 32, 109, 101, 61, 104, 101, 120, 32, 115, 117, 98, 109, 101, 61, 55, 32, 112, 115, 121, 61, 49, 32, 112, 115, 121, 95, 114, 100, 61, 49, 46, 48, 48, 58, 48, 46, 48, 48, 32, 109, 105, 120, 101, 100, 95, 114, 101, 102, 61, 49, 32, 109, 101, 95, 114, 97, 110, 103, 101, 61, 49, 54, 32, 99, 104, 114, 111, 109, 97, 95, 109, 101, 61, 49, 32, 116, 114, 101, 108, 108, 105, 115, 61, 49, 32, 56, 120, 56, 100, 99, 116, 61, 49, 32, 99, 113, 109, 61, 48, 32, 100, 101, 97, 100, 122, 111, 110, 101, 61, 50, 49, 44, 49, 49, 32, 102, 97, 115, 116, 95, 112, 115, 107, 105, 112, 61, 49, 32, 99, 104, 114, 111, 109, 97, 95, 113, 112, 95, 111, 102, 102, 115, 101,
116, 61, 45, 50, 32, 116, 104, 114, 101, 97, 100, 115, 61, 54, 32, 108, 111, 111, 107, 97, 104, 101, 97, 100, 95, 116, 104, 114, 101, 97, 100, 115, 61, 49, 32, 115, 108, 105, 99, 101, 100, 95, 116, 104, 114, 101, 97, 100, 115, 61, 48, 32, 110, 114, 61, 48, 32, 100, 101, 99, 105, 109, 97, 116, 101, 61, 49, 32, 105, 110, 116, 101, 114, 108, 97, 99, 101, 100, 61, 48, 32, 98, 108, 117, 114, 97, 121, 95, 99, 111, 109, 112, 97, 116, 61, 48, 32, 99, 111, 110, 115, 116, 114, 97, 105, 110, 101, 100, 95, 105, 110, 116, 114, 97, 61, 48, 32, 98, 102, 114, 97, 109, 101, 115, 61,
51, 32, 98, 95, 112, 121, 114, 97, 109, 105, 100, 61, 50, 32, 98, 95, 97, 100, 97, 112, 116, 61, 49, 32, 98, 95, 98, 105, 97, 115, 61, 48, 32, 100, 105, 114, 101, 99, 116, 61, 49, 32, 119, 101, 105, 103, 104, 116, 98, 61, 49, 32, 111, 112, 101, 110, 95, 103, 111, 112, 61, 48, 32, 119, 101, 105, 103, 104, 116, 112, 61, 50, 32, 107, 101, 121, 105, 110, 116, 61, 50, 53, 48, 32, 107, 101, 121, 105, 110, 116, 95, 109, 105, 110, 61, 50, 53, 32, 115, 99, 101, 110, 101, 99, 117, 116, 61, 52, 48, 32, 105, 110, 116, 114, 97, 95, 114, 101, 102, 114, 101, 115, 104, 61, 48, 32, 114, 99, 95, 108, 111, 111, 107, 97, 104, 101, 97, 100, 61, 52, 48, 32, 114, 99, 61, 99, 114, 102, 32, 109, 98, 116, 114, 101, 101, 61, 49, 32, 99, 114, 102, 61, 50, 51, 46, 48, 32, 113, 99, 111, 109, 112, 61, 48, 46, 54, 48, 32, 113, 112, 109, 105, 110, 61, 48, 32, 113, 112, 109, 97, 120, 61, 54, 57, 32, 113, 112, 115, 116, 101, 112, 61, 52, 32, 105, 112, 95, 114, 97, 116, 105, 111, 61, 49, 46, 52, 48, 32, 97, 113, 61, 49, 58, 49, 46, 48, 48, 0, 128, 0, 0, 1, 101, 136, 132, 0, 23, 255, 254, 247, 192, 255, 2, 155, 196, 191, 77, 248, 20, 222, 37, 250, 111, 192, 166, 241, 47, 235, 178, 239, 255, 80, 63, 255, 159, 63, 247, 23, 246, 167, 219, 61, 48, 188, 2, 124, 254, 145, 226, 75, 99, 144, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 2, 201, 119, 115, 47, 251, 25, 246, 189, 132, 203, 136, 219, 55, 82, 174, 120, 214, 36, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 3, 217, 244, 0, 0, 45, 152, 128, 0, 29, 112, 128, 0, 60, 16, 0, 1, 51, 48, 0, 10, 195, 128, 0, 170, 200, 0, 15, 174, 0, 1, 218, 64, 0, 74, 72, 0, 14, 222, 0, 4, 156, 0, 1, 182, 64, 0, 193, 128, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0,
3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 100, 65
];
